version: '3.8'

services:
  # Note: MongoDB is now external (MongoDB Atlas or remote server)
  # The local mongodb service has been removed - using MONGO_URI_DEV from .env

  # Keycloak - OpenID Connect Provider (Mock GitHub/Google OAuth with self-registration)
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: papers2code_dev_keycloak
    ports:
      - "8080:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_HEALTH_ENABLED=true
      - KC_HTTP_RELATIVE_PATH=/
    volumes:
      - ./dev-config/keycloak:/opt/keycloak/data/import:ro
    command: 
      - start-dev
      - --import-realm
    networks:
      - papers2code_dev
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: papers2code_dev_backend
    ports:
      - "5001:5001"
    volumes:
      - ./papers2code_app2:/app/papers2code_app2
      - ./scripts:/app/scripts
      - ./.env:/app/.env:ro
    environment:
      - ENV_TYPE=DEV
      - USE_DEX_OAUTH=true
      # Mock GitHub OAuth (Keycloak)
      - KEYCLOAK_GITHUB_ISSUER_URL=http://keycloak:8080/realms/mock-github
      - KEYCLOAK_GITHUB_CLIENT_ID=papers2code-github
      - KEYCLOAK_GITHUB_CLIENT_SECRET=dev-github-secret
      # Mock Google OAuth (Keycloak)
      - KEYCLOAK_GOOGLE_ISSUER_URL=http://keycloak:8080/realms/mock-google
      - KEYCLOAK_GOOGLE_CLIENT_ID=papers2code-google
      - KEYCLOAK_GOOGLE_CLIENT_SECRET=dev-google-secret
      # MONGO_URI_DEV loaded from .env - auto-selected based on ENV_TYPE
    depends_on:
      keycloak:
        condition: service_healthy
    networks:
      - papers2code_dev
    command: uvicorn papers2code_app2.main:app --host 0.0.0.0 --port 5001 --reload
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5001/" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Frontend
  frontend:
    build:
      context: ./papers2code-ui
      dockerfile: Dockerfile.dev
    container_name: papers2code_dev_frontend
    ports:
      - "5173:5173"
    volumes:
      - ./papers2code-ui/src:/app/src
      - ./papers2code-ui/public:/app/public
    environment:
      - VITE_API_URL=http://localhost:5001
    networks:
      - papers2code_dev
    command: npm run dev -- --host 0.0.0.0

networks:
  papers2code_dev:
    driver: bridge
