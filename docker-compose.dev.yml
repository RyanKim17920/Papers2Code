version: '3.8'

services:
  # Note: MongoDB is now external (MongoDB Atlas or remote server)
  # The local mongodb service has been removed - using MONGO_URI_DEV from .env
  
  # Dex OIDC provider for development OAuth

  # Dex - OpenID Connect Provider (Mock OAuth)
  dex:
    image: ghcr.io/dexidp/dex:v2.44.0
    container_name: papers2code_dev_dex
    ports:
      - "5556:5556"
    volumes:
      - ./dev-config/dex-config.yaml:/etc/dex/config.yaml:ro
    command: ["dex", "serve", "/etc/dex/config.yaml"]
    networks:
      - papers2code_dev

  # Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: papers2code_dev_backend
    ports:
      - "5000:5000"
    volumes:
      - ./papers2code_app2:/app/papers2code_app2
      - ./scripts:/app/scripts
      - ./.env:/app/.env:ro
    environment:
      - ENV_TYPE=DEV
      - DEX_ISSUER_URL=http://dex:5556/dex
      - DEX_CLIENT_ID=papers2code-backend
      - DEX_CLIENT_SECRET=dev-client-secret-change-in-production
      # MONGO_URI_DEV loaded from .env - auto-selected based on ENV_TYPE
    depends_on:
      - dex
    networks:
      - papers2code_dev
    command: uvicorn papers2code_app2.main:app --host 0.0.0.0 --port 5000 --reload

  # Frontend
  frontend:
    build:
      context: ./papers2code-ui
      dockerfile: Dockerfile.dev
    container_name: papers2code_dev_frontend
    ports:
      - "5173:5173"
    volumes:
      - ./papers2code-ui/src:/app/src
      - ./papers2code-ui/public:/app/public
    environment:
      - VITE_API_URL=http://localhost:5000
    networks:
      - papers2code_dev
    command: npm run dev -- --host 0.0.0.0

networks:
  papers2code_dev:
    driver: bridge
